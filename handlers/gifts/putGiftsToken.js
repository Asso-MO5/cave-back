const jose = require('jose')
const { getGiftById, updateGift } = require('../../entities/gifts')
const { mail } = require('../../utils/mail')
const { FROM } = require('../../utils/constants')

async function putGiftToken(req, h) {
  const { token } = req.params

  const payload = JSON.parse(req.payload || '{}')
  const secret = Buffer.from(process.env.API_KEY, 'hex')
  let id = null
  try {
    const { payload } = await jose.jwtDecrypt(token, secret)

    if (payload.iss !== 'cave_front' || payload.aud !== 'cave_back')
      return h.response({ msg: 'auth fail' }).type('json').code(401)

    id = payload.id
  } catch (error) {
    console.error(error)
    return h.response({ msg: 'auth fail' }).type('json').code(401)
  }

  const gift = await getGiftById(id)

  const newEmail = payload.email

  const newGift = {
    ...gift,
    ...payload,
  }
  try {
    await updateGift(id, newGift)
  } catch (e) {
    console.error(e)
    return h.response().code(500)
  }

  if (newEmail) {
    await mail.sendMail({
      to: newEmail,
      subject: 'Association MO5, confirmation Pass "Game Story" Versailles',
      text: `
      Ces informations serviront uniquement √† l'accueil de Game Story, pour autoriser l'entr√©e.

      Information √† donner √† l'accueil: 
        - Nom: ${newGift.name}
        - Pr√©nom: ${newGift.lastname}
        - Code postal: ${newGift.zipCode}

        N'oubliez pas de r√©server votre date et horaire de visite, en choisissant "Entr√©e gratuite"
        https://www.billetweb.fr/game-story

        Ne pas r√©pondre √† cet email.

        Modifier vos informations: ${process.env.FRONT_URL}/gifts/${token}
      `,
      // html: 'Vos cadeaux',
      from: `üíæüñ±Ô∏èüéÆ Association MO5 | Game Story Versailles <${process.env.MAIL_ADDRESS}>`,
    })
  }
  return h.response().code(204)
}

module.exports = { putGiftToken }
